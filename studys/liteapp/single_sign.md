# 单点登录引起的关于微信小程序登录的思考
[前面](../liteapp/single_sign.md)里给出了两种跨域名下的单点登录方案
让我想起来 微信公众号用的是第一种, 而微信小程序好像既不是第一种也不是第二种

公众号的登录显然就是第一种, 流程完全一致
而小程序其实也是第一种 [详细](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html):
  小程序用于检查登录的 Token (或者叫 code) 同样是从认证中心 (微信的小程序后端) 获取的
    小程序 (前端) 需要先利用 wx.checkSession 检查目前后端手里的 code 是不是已经过期了
    如果后端没有 code (第一次登录) 或者已经过期了, 我们就要调用 wx.login 进行登录, 拿一个新 code
  把这个 code 给后端, 后端就可以利用它去微信后端那边做校验, 拿到包括微信小程序的 openid, session_key 等
  后端可以根据 session_key + openid 生成一个新的 token, 用于我们自己小程序前端和后端接下来的通信鉴权
  小程序会把这个 token 存在本地 (localStorage), 之后就用 token 直接和后端通信

而前文第二种方式是没有认证中心的, 所以小程序肯定不是第二种方式, 就是第一种方式, 只不过具体实现有些差异:
  1. 小程序去掉了专门的登录页面, 不用再奇怪的跳来跳去
  2. 小程序每次进来都会先问认证中心, 如果 session 过期了就重新登录
     这个过期不是指 code 过期, 而是 session_key 是否过期
     因为后端可能需要用这个 session_key 解密从微信的后端拿到的数据
  3. 小程序用前端主动存储 token 代替了应用后端往 cookie 里放 token

需要注意的是, 第一种方式中的认证中心给我们应用系统的 **Token (或者叫 code) 是要有一个很短的有效期的**
这样就可以一定程度上防止认证中心跳转回我们的 URL (带有 code) 被分享给别人后造成的鉴权身份被盗用
因为在 code 有效期内我们已经和后端完成了鉴权, 而分享出去后 code 可能已经失效

# 小程序为什么要登录? 不登录行不行?
小程序提供的登录主要是为了帮助**我们应用的前端和后端**基于微信平台的用户信息建立我们应用的**用户体系**
比如: 埋点, 画像, 云调用获取微信用户相关信息等
如果我们的应用不需要这些, 或者不需要基于微信的用户体系, 是可以不使用小程序登录的
而前端小程序本身想要获取用户信息直接调用微信授权接口就可以

# 公众号为什么要登录? 不登录行不行?
显然公众号页面是可以不登录的, 但是如果想获取当前微信用户信息, 就必须登录
那么为什么不能像小程序一样直接请求授权呢? 微信明明已经登录了呀
在微信中是可以的, 但是这些页面是可能运行在微信之外比如其他浏览器里, 那就不受控制了